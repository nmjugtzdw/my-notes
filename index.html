<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudNotes | 2026 éšç§åŠ å¯†ç¬”è®°</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#020617">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            color: #f8fafc;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gradient-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .gradient-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(37, 99, 235, 0.4);
        }

        .note-card {
            transition: all 0.3s ease;
        }

        .note-card:hover {
            border-color: rgba(59, 130, 246, 0.5);
            background: rgba(30, 41, 59, 0.9);
        }

        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        ::-webkit-scrollbar {
            width: 0px;
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .copy-btn-success {
            animation: pulse 0.3s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style>
</head>

<body class="min-h-screen selection:bg-blue-500/30">
    <div id="app" class="max-w-3xl mx-auto px-6 py-12 md:py-20">
        <!-- åŠ¨æ€åŠ è½½åŒº -->
    </div>

    <!-- æç®€è®¾ç½®å¼¹çª— -->
    <div id="settingsModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center hidden p-4">
        <div class="glass w-full max-w-sm p-8 rounded-[2.5rem] shadow-2xl space-y-6">
            <h2 class="text-2xl font-extrabold tracking-tight">âš™ï¸ ç³»ç»Ÿé…ç½®</h2>
            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1">Worker
                        æœåŠ¡åœ°å€</label>
                    <input id="setApi" type="text" placeholder="https://..."
                        class="w-full bg-slate-900/50 border border-slate-700 p-4 rounded-2xl outline-none focus:ring-2 ring-blue-500/50 text-sm transition-all">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1">ç®¡ç†å‘˜å¯†é’¥</label>
                    <input id="setKey" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                        class="w-full bg-slate-900/50 border border-slate-700 p-4 rounded-2xl outline-none focus:ring-2 ring-blue-500/50 text-sm transition-all">
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="closeSettings()"
                    class="flex-1 py-4 text-slate-400 font-semibold rounded-2xl hover:bg-slate-800 transition">å–æ¶ˆ</button>
                <button onclick="saveSettings()"
                    class="flex-1 py-4 gradient-btn text-white font-bold rounded-2xl">ä¿å­˜</button>
            </div>
            <div class="text-center pt-2">
                <a href="https://www.zzzmxxkj.com" target="_blank" rel="noopener"
                    class="text-[10px] text-slate-600 hover:text-slate-400 font-bold tracking-widest uppercase">è®¿é—®å®˜ç½‘
                    www.zzzmxxkj.com</a>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        let apiFromUrl = urlParams.get('api');
        const cfgFromUrl = urlParams.get('cfg');
        if (cfgFromUrl) { try { apiFromUrl = atob(cfgFromUrl); } catch (e) { } }
        const shareId = urlParams.get('share');

        let API_URL = apiFromUrl || localStorage.getItem('cf_notes_api') || "https://api-notes.kkku.dpdns.org";
        let ADMIN_KEY = localStorage.getItem('cf_notes_key') || "";

        const app = document.getElementById('app');
        let selectedImage = null; // å­˜å‚¨é€‰ä¸­çš„å›¾ç‰‡æ–‡ä»¶

        // å¾®ä¿¡æµè§ˆå™¨æ£€æµ‹å‡½æ•°
        function isWeChat() {
            const ua = navigator.userAgent.toLowerCase();
            return ua.includes('micromessenger');
        }

        // å…¶ä»–å†…ç½®æµè§ˆå™¨æ£€æµ‹ï¼ˆQQã€é’‰é’‰ç­‰ï¼‰
        function isInAppBrowser() {
            const ua = navigator.userAgent.toLowerCase();
            
            // å¦‚æœåŒ…å« Chrome ä½†ä¸åŒ…å«å†…ç½®æµè§ˆå™¨æ ‡è¯†,åˆ™è®¤ä¸ºæ˜¯çœŸæ­£çš„ Chrome
            if (ua.includes('chrome') && !ua.includes('micromessenger') &&
                !ua.includes('qq/') && !ua.includes('dingtalk') &&
                !ua.includes('alipay')) {
                return false;
            }
            
            // å¦‚æœåŒ…å« Safari ä½†ä¸åŒ…å«å†…ç½®æµè§ˆå™¨æ ‡è¯†,åˆ™è®¤ä¸ºæ˜¯çœŸæ­£çš„ Safari
            if (ua.includes('safari') && !ua.includes('chrome') &&
                !ua.includes('micromessenger') && !ua.includes('qq/') &&
                !ua.includes('dingtalk') && !ua.includes('alipay')) {
                return false;
            }
            
            // æ£€æµ‹å¸¸è§çš„å†…ç½®æµè§ˆå™¨
            return ua.includes('micromessenger') ||
                   ua.includes('qq/') ||
                   ua.includes('dingtalk') ||
                   ua.includes('alipay');
        }

        // æ˜¾ç¤ºè·³è½¬æç¤ºé¡µé¢
        function showBrowserRedirect() {
            const currentUrl = window.location.href;
            const ua = navigator.userAgent.toLowerCase();
            
            // å°è¯•è‡ªåŠ¨è·³è½¬åˆ°é»˜è®¤æµè§ˆå™¨
            if (ua.includes('micromessenger')) {
                // æ˜¾ç¤ºå¼•å¯¼é¡µé¢ï¼ŒåŒæ—¶å°è¯•æ‰“å¼€æµè§ˆå™¨
                setTimeout(() => {
                    // å°è¯•ä½¿ç”¨åº”ç”¨é“¾æ¥æ–¹å¼æ‰“å¼€
                    window.location.href = 'googlechrome://navigate?url=' + encodeURIComponent(currentUrl);
                    
                    // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨é€šç”¨æµè§ˆå™¨åè®®
                    setTimeout(() => {
                        window.location.href = 'https://c.pc.qq.com/middlem.html?pfurl=' + encodeURIComponent(currentUrl);
                    }, 500);
                }, 1000);
            }
            
            app.innerHTML = `
                <div class="glass p-8 md:p-12 rounded-[3rem] shadow-2xl text-center space-y-8 animate-in zoom-in duration-500">
                    <div class="text-6xl animate-bounce">ğŸš€</div>
                    <div class="space-y-4">
                        <h1 class="text-3xl font-black">è¯·åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€</h1>
                        <p class="text-slate-400 text-sm leading-relaxed">
                            æ£€æµ‹åˆ°æ‚¨æ­£åœ¨å¾®ä¿¡/QQç­‰åº”ç”¨ä¸­è®¿é—®ï¼Œä¸ºäº†è·å¾—æœ€ä½³ä½“éªŒï¼Œè¯·åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€æ­¤é“¾æ¥
                        </p>
                    </div>
                    
                    <div class="bg-slate-900/50 p-6 rounded-2xl space-y-4 text-left">
                        <div class="text-sm text-slate-300 space-y-2">
                            <p class="font-bold text-blue-400">ğŸ“± æ“ä½œæ­¥éª¤ï¼š</p>
                            <div class="pl-4 space-y-1 text-xs">
                                <p>1. ç‚¹å‡»å³ä¸Šè§’ <span class="font-semibold">[ Â·Â·Â· ]</span> èœå•</p>
                                <p>2. é€‰æ‹© <span class="font-semibold">"åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€"</span></p>
                                <p>3. æˆ–å¤åˆ¶é“¾æ¥åˆ° Safari/Chrome ç­‰æµè§ˆå™¨è®¿é—®</p>
                            </div>
                        </div>
                    </div>

                    <button onclick="copyCurrentUrl()" class="w-full gradient-btn text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-xl hover:scale-[1.02] transition">
                        ğŸ“‹ å¤åˆ¶é“¾æ¥
                    </button>

                    <div class="bg-gradient-to-r from-orange-500/10 to-red-500/10 border border-orange-500/30 p-4 rounded-2xl">
                        <p class="text-xs text-orange-300 leading-relaxed">
                            ğŸ’¡ æ¨èä½¿ç”¨ Safariã€Chromeã€Edge ç­‰æµè§ˆå™¨è®¿é—®
                        </p>
                    </div>

                    <div class="pt-8 border-t border-white/5">
                        <a href="https://www.zzzmxxkj.com" target="_blank" rel="noopener" class="text-xs font-black uppercase tracking-widest text-slate-500 hover:text-slate-400 transition">@æ¡¢é¸£ç§‘æŠ€</a>
                    </div>
                </div>
            `;
        }
        
        // å¤åˆ¶å½“å‰URL
        function copyCurrentUrl() {
            const url = window.location.href;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    showToast('âœ… é“¾æ¥å·²å¤åˆ¶ï¼è¯·åœ¨æµè§ˆå™¨ä¸­ç²˜è´´æ‰“å¼€');
                }).catch(() => {
                    prompt('è¯·æ‰‹åŠ¨å¤åˆ¶æ­¤é“¾æ¥:', url);
                });
            } else {
                prompt('è¯·æ‰‹åŠ¨å¤åˆ¶æ­¤é“¾æ¥:', url);
            }
        }

        // åŠ è§£å¯†é€»è¾‘
        async function getK(pw) {
            const enc = new TextEncoder();
            const hash = await crypto.subtle.digest('SHA-256', enc.encode(pw));
            return await crypto.subtle.importKey('raw', hash, { name: 'AES-GCM' }, false, ['encrypt', 'decrypt']);
        }
        async function encrypt(text, pw) {
            const enc = new TextEncoder(); const iv = crypto.getRandomValues(new Uint8Array(12)); const key = await getK(pw);
            const cipher = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, enc.encode(text));
            return btoa(JSON.stringify({ iv: Array.from(iv), data: Array.from(new Uint8Array(cipher)) }));
        }
        async function decrypt(json, pw) {
            try {
                const { iv, data } = JSON.parse(atob(json)); const key = await getK(pw);
                const dec = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: new Uint8Array(iv) }, key, new Uint8Array(data));
                return new TextDecoder().decode(dec);
            } catch (e) { return null; }
        }

        function init() {
            // å¦‚æœæ˜¯åˆ†äº«é“¾æ¥ä¸”åœ¨å†…ç½®æµè§ˆå™¨ä¸­æ‰“å¼€ï¼Œæ˜¾ç¤ºè·³è½¬æç¤º
            if (shareId && isInAppBrowser()) {
                showBrowserRedirect();
                return;
            }
            
            if (shareId) renderShareView();
            else if (!API_URL) renderWelcomeView();
            else renderMainView();
        }

        function renderWelcomeView() {
            app.innerHTML = `
            <div class="glass p-12 rounded-[3rem] text-center space-y-8 animate-in fade-in zoom-in duration-700">
                <div class="inline-flex p-5 bg-blue-500/10 rounded-full text-5xl">ğŸ›¡ï¸</div>
                <div class="space-y-2">
                    <h1 class="text-4xl font-extrabold tracking-tight italic">CloudNotes</h1>
                    <p class="text-slate-400 leading-relaxed">æ‚¨çš„ä¸“å±åˆ†å¸ƒå¼åŠ å¯†ç¬”è®°ç³»ç»Ÿ<br>è¯·å…ˆå…³è”æ‚¨çš„ Cloudflare Worker åç«¯</p>
                </div>
                <button onclick="configUrl()" class="px-10 py-5 gradient-btn text-white font-black rounded-3xl shadow-2xl">åˆå§‹åŒ–é…ç½®</button>
            </div>
        `;
        }

        function renderMainView() {
            app.innerHTML = `
            <div class="space-y-12 animate-in fade-in slide-in-from-bottom-4 duration-700">
                <header class="flex justify-between items-end">
                    <div class="space-y-1">
                        <h1 class="text-4xl font-extrabold tracking-tighter bg-gradient-to-r from-white to-slate-500 bg-clip-text text-transparent">CloudNotes</h1>
                        <p class="text-[10px] uppercase tracking-[0.3em] text-blue-500 font-black">ç«¯åˆ°ç«¯åŠ å¯†ä¿é™©åº“</p>
                    </div>
                    <button onclick="configUrl()" class="p-4 glass rounded-2xl hover:rotate-180 transition-all duration-500 text-xl">âš™ï¸</button>
                </header>

                <main class="glass p-8 rounded-[2.5rem] shadow-2xl space-y-6 border-white/5">
                    <input id="mainPw" type="password" placeholder="è®¾ç½®è§£å¯†ä¸»å¯†ç  (Passkey)" class="w-full bg-slate-950/50 border border-slate-800 p-5 rounded-2xl outline-none focus:ring-2 ring-blue-500/50 transition-all font-mono">
                    <textarea id="noteInput" placeholder="åœ¨æ­¤è¾“å…¥ç§äººå†…å®¹..." class="w-full bg-slate-950/50 border border-slate-800 p-5 h-48 rounded-2xl outline-none focus:bg-slate-950 transition-all resize-none leading-relaxed"></textarea>
                    
                    <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
                    <div class="border-2 border-dashed border-slate-700/50 rounded-2xl p-6 hover:border-slate-600 transition-all">
                        <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="handleImageSelect(event)">
                        <div class="flex items-center justify-center gap-4">
                            <button onclick="document.getElementById('imageInput').click()" type="button" class="glass px-6 py-3 rounded-xl font-bold text-sm hover:bg-slate-800 transition flex items-center gap-2">
                                ğŸ“· <span>æ·»åŠ å›¾ç‰‡ (å¯é€‰)</span>
                            </button>
                            <span id="imageStatus" class="text-xs text-slate-500">æ”¯æŒ PNG/JPG/GIF/WEBPï¼Œæœ€å¤§ 700KB</span>
                        </div>
                        <div id="imagePreview" class="mt-4 hidden">
                            <div class="relative inline-block">
                                <img id="previewImg" class="image-preview rounded-xl border border-slate-700">
                                <button onclick="clearImage()" type="button" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600 transition text-xs font-bold">âœ•</button>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="doSave()" class="gradient-btn text-white py-5 rounded-2xl font-black tracking-widest uppercase text-xs">åŠ å¯†å­˜å…¥äº‘ç«¯</button>
                        <button onclick="doAI()" class="glass text-purple-400 py-5 rounded-2xl font-black tracking-widest uppercase text-xs hover:bg-purple-500/10 transition border-purple-500/20">âœ¨ AI æ™ºèƒ½æ€»ç»“</button>
                    </div>
                </main>

                <section class="space-y-6">
                    <div class="flex justify-between items-center px-4">
                        <h2 class="text-xs font-black uppercase tracking-[0.2em] text-slate-500 italic">Vault / æˆ‘çš„åŠ å¯†åº“</h2>
                        <button onclick="loadList()" class="text-blue-500 text-xs font-black hover:underline uppercase">åˆ·æ–°åˆ—è¡¨</button>
                    </div>
                    <div id="notesList" class="space-y-4">
                        <div class="text-center py-20 text-slate-600 italic text-sm">é…ç½®æš—å·å¹¶å¡«å…¥å¯†ç åç‚¹å‡»åˆ·æ–°ã€‚</div>
                    </div>
                </section>
                <footer class="text-center pt-8 pb-4 opacity-50 hover:opacity-100 transition duration-500">
                     <a href="https://www.zzzmxxkj.com" target="_blank" rel="noopener" class="text-[10px] text-slate-500 font-bold hover:text-blue-400 uppercase tracking-widest transition">@æ¡¢é¸£ç§‘æŠ€</a>
                </footer>
            </div>
        `;
        }

        function renderShareView() {
            app.innerHTML = `
            <div class="glass p-12 rounded-[3rem] shadow-2xl text-center space-y-8 animate-in zoom-in duration-500">
                <div class="text-6xl animate-bounce">ğŸ”¥</div>
                <div class="space-y-2">
                    <h1 class="text-3xl font-black italic">é˜…åå³ç„šè§£å¯†</h1>
                    <p class="text-slate-400 text-sm">è§£å¯†åæ•°æ®å°†ç«‹å³ä»æœåŠ¡å™¨ç‰©ç†æ“¦é™¤</p>
                </div>
                <input id="sharePw" type="password" placeholder="è¯·è¾“å…¥ 6 ä½ä»¥ä¸Šè§£å¯†å¯†ç " class="w-full bg-slate-950/50 border border-slate-800 p-5 rounded-2xl outline-none focus:ring-2 ring-orange-500/50 text-center font-mono">
                <button id="unlockBtn" onclick="doUnlockShare()" class="w-full bg-gradient-to-r from-orange-600 to-red-600 text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-xl hover:scale-[1.02] transition">è§£å¯†å¹¶é”€æ¯</button>
                <div id="shareResult" class="mt-8 text-left p-6 bg-slate-950/50 rounded-2xl hidden whitespace-pre-wrap text-sm leading-relaxed border border-orange-500/20 ring-1 ring-orange-500/10 shadow-inner italic text-slate-300"></div>
                <div id="shareImageResult" class="mt-4 hidden">
                    <img id="shareImg" class="image-preview rounded-xl border border-orange-500/20 mx-auto">
                </div>
                <div class="pt-8 border-t border-white/5">
                    <a href="https://www.zzzmxxkj.com" target="_blank" rel="noopener" class="text-xs font-black uppercase tracking-widest text-red-500 hover:text-red-400 transition underline underline-offset-4">ğŸ¬ @æ¡¢é¸£ç§‘æŠ€</a>
                </div>
            </div>
        `;
        }

        /* --- åŠŸèƒ½é€»è¾‘ --- */
        function configUrl() {
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('setApi').value = API_URL;
            document.getElementById('setKey').value = ADMIN_KEY;
        }
        function closeSettings() { document.getElementById('settingsModal').classList.add('hidden'); }
        function saveSettings() {
            localStorage.setItem('cf_notes_api', document.getElementById('setApi').value);
            localStorage.setItem('cf_notes_key', document.getElementById('setKey').value);
            location.reload();
        }

        async function doSave() {
            const text = document.getElementById('noteInput').value; const pw = document.getElementById('mainPw').value;
            if (!text || !pw) return alert("è¯·å¡«å†™å†…å®¹å’Œå¯†ç ");
            try {
                const cipher = await encrypt(text, pw);
                const payload = { content: cipher };

                // å¦‚æœæœ‰å›¾ç‰‡ï¼ŒåŠ å¯†å¹¶æ·»åŠ åˆ° payload
                if (selectedImage) {
                    const imgData = await encryptImage(selectedImage, pw);
                    payload.has_image = 1;
                    payload.image_data = imgData.data;
                    payload.image_type = imgData.type;
                    payload.image_iv = JSON.stringify(imgData.iv);
                }

                const res = await fetch(`${API_URL}/api/save`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': ADMIN_KEY },
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    showToast("âœ… å·²å­˜å…¥å®‰å…¨åº“");
                    document.getElementById('noteInput').value = "";
                    clearImage();
                    loadList();
                } else {
                    const errorData = await res.json().catch(() => ({}));
                    const errorMsg = errorData.error || "ä¿å­˜å¤±è´¥";
                    const hint = errorData.hint ? `\n\nğŸ’¡ æç¤º: ${errorData.hint}` : "";
                    alert(`âŒ ${errorMsg}${hint}`);
                }
            } catch (e) { alert("âŒ ç½‘ç»œè¿æ¥å¤±è´¥: " + e.message); }
        }

        async function loadList() {
            const pw = document.getElementById('mainPw').value; if (!pw) return alert("è¯·è¾“å…¥å¯†ç è§£å¯†");
            const listDiv = document.getElementById('notesList');
            try {
                const res = await fetch(`${API_URL}/api/list`, { headers: { 'Authorization': ADMIN_KEY } });
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({}));
                    const errorMsg = errorData.error || "è·å–åˆ—è¡¨å¤±è´¥";
                    const hint = errorData.hint ? `\n\nğŸ’¡ ${errorData.hint}` : "";
                    alert(`âŒ ${errorMsg}${hint}`);
                    return;
                }
                const notes = await res.json(); listDiv.innerHTML = "";
                if (notes.length === 0) listDiv.innerHTML = '<div class="text-center py-20 text-slate-700 italic text-sm">æš‚æ— æ•°æ®</div>';
                for (let n of notes) {
                    const clearText = await decrypt(n.content, pw) || "ğŸ”’ [åŠ å¯†æ•°æ® / å¯†ç ä¸åŒ¹é…]";
                    const card = document.createElement('div');
                    card.className = "note-card glass p-6 rounded-3xl space-y-4 border border-white/5 shadow-lg group";
                    
                    let imageHtml = '';
                    if (n.has_image && n.image_data) {
                        try {
                            const imgBlob = await decryptImage({
                                data: n.image_data,
                                iv: JSON.parse(n.image_iv || '[]'),
                                type: n.image_type
                            }, pw);
                            const imgUrl = URL.createObjectURL(imgBlob);
                            imageHtml = `<div class="mt-4"><img src="${imgUrl}" class="image-preview rounded-xl border border-slate-700 cursor-pointer" onclick="window.open('${imgUrl}', '_blank')"></div>`;
                        } catch (e) {
                            imageHtml = '<div class="text-xs text-red-400 mt-2">ğŸ”’ å›¾ç‰‡è§£å¯†å¤±è´¥</div>';
                        }
                    }

                    card.innerHTML = `
                    <div class="flex justify-between text-[9px] font-black text-slate-500 tracking-widest uppercase italic">
                        <span>ç´¢å¼•ç¼–å· #${n.id} ${n.has_image ? 'ğŸ“·' : ''}</span>
                        <span>${new Date(n.created_at).toLocaleString()}</span>
                    </div>
                    <div class="text-slate-300 text-sm leading-relaxed whitespace-pre-wrap">${clearText}</div>
                    ${imageHtml}
                    <div class="pt-4 border-t border-white/5 flex flex-wrap gap-6 items-center">
                        <button onclick="doShareCopy(${n.id})" class="text-xs font-black text-blue-400 uppercase tracking-widest hover:text-blue-300 transition">ğŸ“¤ ç”Ÿæˆé˜…åå³ç„šé“¾æ¥</button>
                        <button onclick="doExport(\`${clearText.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`, ${n.id})" class="text-xs font-black text-emerald-500 uppercase tracking-widest hover:text-emerald-400 transition">ğŸ’¾ å¯¼å‡ºå¤‡ä»½</button>
                        <button onclick="doDelete(${n.id})" class="text-xs font-black text-rose-500 uppercase tracking-widest ml-auto opacity-40 group-hover:opacity-100 transition">ğŸ—‘ï¸ åˆ é™¤</button>
                    </div>
                `;
                    listDiv.appendChild(card);
                }
            } catch (e) { alert("æ‹‰å–å¤±è´¥"); }
        }

        async function doShareCopy(noteId) {
            const pid = Math.random().toString(36).substring(2, 12);
            try {
                // è·å–åŸå§‹ç¬”è®°æ•°æ®
                const res = await fetch(`${API_URL}/api/list`, { headers: { 'Authorization': ADMIN_KEY } });
                const notes = await res.json();
                const note = notes.find(n => n.id === noteId);
                if (!note) return alert("ç¬”è®°ä¸å­˜åœ¨");

                // åˆ›å»ºåˆ†äº«å‰¯æœ¬
                const sharePayload = {
                    content: note.content,
                    public_id: pid,
                    is_share_copy: 1
                };
                if (note.has_image) {
                    sharePayload.has_image = 1;
                    sharePayload.image_data = note.image_data;
                    sharePayload.image_type = note.image_type;
                    sharePayload.image_iv = note.image_iv;
                }

                await fetch(`${API_URL}/api/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': ADMIN_KEY },
                    body: JSON.stringify(sharePayload)
                });
                
                const shareUrl = `${window.location.origin}${window.location.pathname}?share=${pid}&cfg=${btoa(API_URL)}`;
                const wechatUrl = `https://c.pc.qq.com/middlem.html?pfurl=${encodeURIComponent(shareUrl)}`;
                
                // æ˜¾ç¤ºå¸¦å¤åˆ¶æŒ‰é’®çš„æç¤º
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center p-4';
                modal.innerHTML = `
                    <div class="glass max-w-lg w-full p-8 rounded-3xl space-y-6 animate-in zoom-in duration-300">
                        <h3 class="text-2xl font-bold text-center">ğŸ”— é˜…åå³ç„šé“¾æ¥å·²ç”Ÿæˆ</h3>
                        
                        <div class="space-y-3">
                            <div>
                                <div class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1">åŸå§‹ç›´è¾¾é“¾æ¥</div>
                                <div class="flex gap-3 items-stretch">
                                    <div class="flex-1 min-w-0 bg-slate-950/50 p-4 rounded-xl break-all text-sm text-slate-300 font-mono">${shareUrl}</div>
                                    <button onclick="copyToClipboard('${shareUrl}', this)" class="px-4 glass rounded-xl font-bold hover:bg-slate-800 transition whitespace-nowrap">ğŸ“‹ å¤åˆ¶</button>
                                </div>
                            </div>
                            <div>
                                <div class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1">å¾®ä¿¡ä¸­è½¬é“¾æ¥</div>
                                <div class="flex gap-3 items-stretch">
                                    <div class="flex-1 min-w-0 bg-slate-950/50 p-4 rounded-xl break-all text-xs text-slate-400 font-mono">${wechatUrl}</div>
                                    <button onclick="copyToClipboard('${wechatUrl}', this)" class="px-4 glass rounded-xl font-bold hover:bg-slate-800 transition whitespace-nowrap">ğŸ“‹ å¤åˆ¶</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-500/10 border border-blue-500/30 p-4 rounded-xl">
                            <p class="text-xs text-blue-300 leading-relaxed">
                                ğŸ’¡ <strong>æ¸©é¦¨æç¤º:</strong> åœ¨ Chrome/Safari/Edge ä¸­æ‰“å¼€è¯·ç”¨â€œåŸå§‹ç›´è¾¾é“¾æ¥â€ã€‚ä»å¾®ä¿¡å†…åˆ†äº«/ç‚¹å¼€æ—¶å¯é€‰â€œå¾®ä¿¡ä¸­è½¬é“¾æ¥â€ã€‚
                            </p>
                        </div>
                        
                        <div class="flex justify-center">
                            <button onclick="this.closest('.fixed').remove()" class="px-10 py-4 glass rounded-2xl font-bold hover:bg-slate-800 transition">å…³é—­</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (e) { alert("åˆ†äº«å¤±è´¥: " + e.message); }
        }

        async function copyToClipboard(text, btn) {
            try {
                await navigator.clipboard.writeText(text);
                const original = btn.innerHTML;
                btn.innerHTML = 'âœ… å·²å¤åˆ¶';
                btn.classList.add('copy-btn-success');
                showToast('âœ… é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                setTimeout(() => {
                    btn.innerHTML = original;
                    btn.classList.remove('copy-btn-success');
                }, 2000);
            } catch (err) {
                prompt('è¯·æ‰‹åŠ¨å¤åˆ¶æ­¤é“¾æ¥:', text);
            }
        }

        async function doExport(text, id) {
            const date = new Date().toISOString().split('T')[0];
            const pw = document.getElementById('mainPw').value;
            
            try {
                // è·å–ç¬”è®°æ•°æ®ä»¥æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡
                const res = await fetch(`${API_URL}/api/list`, { headers: { 'Authorization': ADMIN_KEY } });
                const notes = await res.json();
                const note = notes.find(n => n.id === id);
                
                // å¯¼å‡ºæ–‡æœ¬
                const textBlob = new Blob([text], { type: 'text/plain;charset=utf-8' });
                const textUrl = URL.createObjectURL(textBlob);
                const textLink = document.createElement('a');
                textLink.href = textUrl;
                textLink.download = `CloudNote_${id}_${date}.txt`;
                textLink.click();
                URL.revokeObjectURL(textUrl);
                
                // å¦‚æœæœ‰å›¾ç‰‡ï¼Œä¹Ÿå¯¼å‡ºå›¾ç‰‡
                if (note && note.has_image && note.image_data) {
                    try {
                        const imgBlob = await decryptImage({
                            data: note.image_data,
                            iv: JSON.parse(note.image_iv || '[]'),
                            type: note.image_type
                        }, pw);
                        
                        // è·å–å›¾ç‰‡æ‰©å±•å
                        const ext = note.image_type.split('/')[1] || 'png';
                        const imgUrl = URL.createObjectURL(imgBlob);
                        const imgLink = document.createElement('a');
                        imgLink.href = imgUrl;
                        imgLink.download = `CloudNote_${id}_${date}_image.${ext}`;
                        
                        // å»¶è¿Ÿä¸€ç‚¹ä¸‹è½½å›¾ç‰‡ï¼Œé¿å…æµè§ˆå™¨é˜»æ­¢å¤šæ¬¡ä¸‹è½½
                        setTimeout(() => {
                            imgLink.click();
                            URL.revokeObjectURL(imgUrl);
                            showToast('âœ… å·²å¯¼å‡ºæ–‡æœ¬å’Œå›¾ç‰‡');
                        }, 500);
                    } catch (e) {
                        console.error('å›¾ç‰‡å¯¼å‡ºå¤±è´¥:', e);
                        showToast('âš ï¸ æ–‡æœ¬å·²å¯¼å‡ºï¼Œä½†å›¾ç‰‡è§£å¯†å¤±è´¥');
                    }
                } else {
                    showToast('âœ… å·²å¯¼å‡ºæ–‡æœ¬');
                }
            } catch (e) {
                console.error('å¯¼å‡ºå¤±è´¥:', e);
                showToast('âŒ å¯¼å‡ºå¤±è´¥: ' + e.message);
            }
        }

        async function doDelete(id) {
            if (!confirm("ç¡®å®šè¦ç‰©ç†æŠ¹é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) return;
            await fetch(`${API_URL}/api/delete`, {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': ADMIN_KEY },
                body: JSON.stringify({ id: id })
            });
            loadList();
        }

        async function doAI() {
            const text = document.getElementById('noteInput').value; if (!text) return alert("ç¬”è®°ä¸ºç©º");
            const btn = event.target; btn.innerText = "æ€è€ƒä¸­..."; btn.disabled = true;
            try {
                const res = await fetch(`${API_URL}/api/ai-sum`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': ADMIN_KEY },
                    body: JSON.stringify({ text: text.substring(0, 1000) })
                });
                const data = await res.json();
                if (data.error) {
                    alert(`âŒ ${data.error}\n\n${data.summary || ''}`);
                } else {
                    document.getElementById('noteInput').value += `\n\n--- âœ¨ AI SUMMARY ---\n${data.summary}`;
                }
            } finally { btn.innerText = "âœ¨ AI æ™ºèƒ½æ€»ç»“"; btn.disabled = false; }
        }

        async function doUnlockShare() {
            const pw = document.getElementById('sharePw').value;
            const resDiv = document.getElementById('shareResult');
            const imgDiv = document.getElementById('shareImageResult');
            const btn = document.getElementById('unlockBtn');
            
            try {
                const res = await fetch(`${API_URL}/api/share/${shareId}`);
                if (!res.ok) return alert("å¤±æ•ˆæˆ–å·²è¢«ç„šæ¯");
                const data = await res.json();
                const clearText = await decrypt(data.content, pw);
                
                if (clearText) {
                    resDiv.innerText = clearText;
                    resDiv.classList.remove('hidden');
                    
                    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œè§£å¯†å¹¶æ˜¾ç¤º
                    if (data.has_image && data.image_data) {
                        try {
                            const imgBlob = await decryptImage({
                                data: data.image_data,
                                iv: JSON.parse(data.image_iv || '[]'),
                                type: data.image_type
                            }, pw);
                            const imgUrl = URL.createObjectURL(imgBlob);
                            document.getElementById('shareImg').src = imgUrl;
                            imgDiv.classList.remove('hidden');
                        } catch (e) {
                            console.error('å›¾ç‰‡è§£å¯†å¤±è´¥:', e);
                        }
                    }
                    
                    btn.disabled = true;
                    btn.innerText = "ğŸ”¥ æ•°æ®å·²é”€æ¯";
                    showToast('âš ï¸ å†…å®¹å·²è§£å¯†ï¼ŒæœåŠ¡å™¨æ•°æ®å·²æ°¸ä¹…åˆ é™¤');
                }
                else alert("å¯†ç é”™è¯¯");
            } catch (e) { alert("ç½‘ç»œå¼‚å¸¸: " + e.message); }
        }

        // å›¾ç‰‡å¤„ç†å‡½æ•°
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!file.type.match(/^image\/(png|jpeg|jpg|gif|webp)$/)) {
                alert('âŒ ä»…æ”¯æŒ PNGã€JPGã€GIFã€WEBP æ ¼å¼');
                event.target.value = '';
                return;
            }

            // éªŒè¯æ–‡ä»¶å¤§å° - D1 æ•°æ®åº“é™åˆ¶ï¼Œå»ºè®® < 700KB
            const maxSize = 700 * 1024; // 700KB
            if (file.size > maxSize) {
                alert(`âŒ å›¾ç‰‡å¤ªå¤§ (${(file.size / 1024).toFixed(1)} KB)\n\nç”±äºæ•°æ®åº“é™åˆ¶ï¼Œå›¾ç‰‡å¤§å°å¿…é¡»å°äº 700KB\n\nğŸ’¡ å»ºè®®:\n1. ä½¿ç”¨åœ¨çº¿å·¥å…·å‹ç¼©å›¾ç‰‡: https://tinypng.com\n2. æˆ–ä½¿ç”¨å›¾ç‰‡ç¼–è¾‘è½¯ä»¶é™ä½è´¨é‡\n3. æˆ–è°ƒæ•´å›¾ç‰‡å°ºå¯¸`);
                event.target.value = '';
                return;
            }

            selectedImage = file;
            
            // æ˜¾ç¤ºé¢„è§ˆ
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('imagePreview').classList.remove('hidden');
                const sizeKB = (file.size / 1024).toFixed(1);
                const sizeClass = file.size < 500 * 1024 ? 'text-green-400' : 'text-yellow-400';
                document.getElementById('imageStatus').textContent = `âœ… ${file.name} (${sizeKB} KB)`;
                document.getElementById('imageStatus').className = `text-xs ${sizeClass}`;
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            selectedImage = null;
            document.getElementById('imageInput').value = '';
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('imageStatus').textContent = 'æ”¯æŒ PNG/JPG/GIF/WEBPï¼Œæœ€å¤§ 700KB';
            document.getElementById('imageStatus').className = 'text-xs text-slate-500';
        }

        async function encryptImage(file, password) {
            const arrayBuffer = await file.arrayBuffer();
            const key = await getK(password);
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv },
                key,
                arrayBuffer
            );
            
            // ä½¿ç”¨åˆ†å—æ–¹å¼è½¬æ¢ä¸º Base64ï¼Œé¿å…æ ˆæº¢å‡º
            const encryptedArray = new Uint8Array(encrypted);
            const chunkSize = 8192;
            let binaryString = '';
            
            for (let i = 0; i < encryptedArray.length; i += chunkSize) {
                const chunk = encryptedArray.subarray(i, Math.min(i + chunkSize, encryptedArray.length));
                binaryString += String.fromCharCode.apply(null, chunk);
            }
            
            return {
                data: btoa(binaryString),
                iv: Array.from(iv),
                type: file.type
            };
        }

        async function decryptImage(encryptedData, password) {
            const { data, iv, type } = encryptedData;
            const key = await getK(password);
            const binaryString = atob(data);
            
            // ä½¿ç”¨åˆ†å—æ–¹å¼å¤„ç†å¤§æ•°æ®
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            
            const decrypted = await crypto.subtle.decrypt(
                { name: 'AES-GCM', iv: new Uint8Array(iv) },
                key,
                bytes
            );
            return new Blob([decrypted], { type });
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast glass px-6 py-4 rounded-2xl shadow-2xl font-bold';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(() => console.log('Service Worker Registered'))
                .catch(err => console.error('Service Worker Registration Failed', err));
        }

        init();
    </script>
</body>

</html>
