# CloudNotes 功能更新说明 v2.0

## 🎉 新增功能

### 1. 📷 图片加密上传支持

现在你可以在笔记中添加图片，图片会使用与文本相同的 AES-GCM 加密算法进行端到端加密。

**功能特点:**
- 支持格式: PNG, JPEG, JPG, GIF, WEBP
- 文件大小限制: 最大 5MB
- 加密方式: AES-GCM-256
- 存储方式: Base64 编码后存储到数据库
- 预览功能: 上传前可以预览图片

**使用方法:**
1. 在主界面的笔记输入框下方，点击 "📷 添加图片 (可选)" 按钮
2. 选择图片文件（或拖拽图片到选择区域）
3. 图片会显示预览，可以点击 ✕ 按钮取消选择
4. 输入密码和笔记内容后，点击 "加密存入云端"
5. 图片会和文本一起加密上传

### 2. 📋 分享链接复制按钮

生成阅后即焚链接时，新增了便捷的复制功能。

**功能特点:**
- 点击 "📤 生成阅后即焚链接" 后会弹出模态窗口
- 窗口中显示完整的分享链接
- 点击 "📋 复制链接" 按钮一键复制到剪贴板
- 复制成功后会显示 "✅ 已复制" 提示
- 同时会有 Toast 提示 "✅ 链接已复制到剪贴板"

**浏览器兼容性:**
- 现代浏览器: 使用 `navigator.clipboard.writeText()` API
- 旧版浏览器: 降级使用 `prompt()` 方式让用户手动复制

### 3. 🔥 阅后即焚图片支持

分享的笔记如果包含图片，解密后图片也会一同显示，并在查看后从服务器永久删除。

**功能特点:**
- 分享链接包含文本和图片的完整加密数据
- 解密成功后，文本和图片同时显示
- 服务器端数据立即销毁（包括图片数据）
- 链接只能访问一次
- 解密后按钮变为 "🔥 数据已销毁" 状态

### 4. ✨ UI/UX 优化

**新增视觉效果:**
- Toast 通知系统: 操作成功时右上角滑入提示
- 复制按钮动画: 点击复制时有脉冲动画效果
- 图片预览优化: 点击笔记中的图片可在新窗口查看大图
- 图片标识: 含图片的笔记会在标题显示 📷 图标

**交互改进:**
- 图片上传状态提示更清晰
- 文件大小和格式实时验证
- 错误提示更友好
- 操作反馈更及时

---

## 🔐 技术实现

### 加密流程

**图片加密:**
```
选择图片 → 读取为 ArrayBuffer 
→ 使用用户密码生成 AES-GCM 密钥
→ 生成随机 IV (12 bytes)
→ 加密图片数据
→ 转换为 Base64
→ 连同 IV 和类型信息一起上传
```

**图片解密:**
```
从服务器获取加密数据
→ Base64 解码
→ 使用用户密码和 IV 解密
→ 创建 Blob 对象
→ 生成临时 URL
→ 显示在 <img> 标签中
```

### 安全保证

1. **端到端加密**: 所有加密操作在客户端进行，服务器只存储密文
2. **密钥隔离**: 每个笔记使用独立的 IV，即使密码相同也无法交叉解密
3. **阅后即焚**: 分享链接查看后立即从数据库物理删除
4. **客户端验证**: 文件大小和格式在上传前验证
5. **服务器验证**: 后端应同样验证数据完整性（见 BACKEND_UPDATE_GUIDE.md）

---

## 📊 数据库变更

### 新增字段

```sql
has_image INTEGER DEFAULT 0      -- 是否包含图片
image_data TEXT                  -- 加密的图片 Base64 数据
image_type VARCHAR(50)           -- MIME 类型
image_iv TEXT                    -- 加密 IV (JSON 数组)
```

详细的数据库迁移脚本和后端代码示例请参考 [`BACKEND_UPDATE_GUIDE.md`](./BACKEND_UPDATE_GUIDE.md)

---

## 🚀 使用示例

### 场景 1: 保存带图片的私密笔记

1. 输入笔记内容
2. 点击 "📷 添加图片" 选择照片
3. 设置主密码（至少 6 位）
4. 点击 "加密存入云端"
5. 笔记和图片都会被加密保存

### 场景 2: 分享带图片的阅后即焚内容

1. 在笔记列表中找到要分享的笔记
2. 点击 "📤 生成阅后即焚链接"
3. 在弹窗中点击 "📋 复制链接"
4. 将链接发送给接收者
5. 接收者访问链接，输入密码解密
6. 查看内容和图片后，数据自动从服务器销毁

### 场景 3: 导出备份

1. 加载笔记列表（输入密码后点击刷新）
2. 找到要备份的笔记
3. 点击 "💾 导出备份"
4. 文本内容会下载为 .txt 文件
5. **注意**: 图片需要单独截图或右键保存

---

## ⚠️ 注意事项

1. **图片大小**: 建议每张图片不超过 5MB，过大的图片会增加加载时间
2. **浏览器兼容性**: 需要支持 Web Crypto API 的现代浏览器
3. **密码管理**: 请妥善保管密码，密码丢失无法恢复加密内容
4. **导出限制**: 目前导出功能只支持文本内容，图片需要单独保存
5. **分享安全**: 阅后即焚链接只能访问一次，分享前请确认
6. **数据迁移**: 更新后需要更新后端和数据库结构

---

## 🔄 升级指南

### 对于用户

1. 刷新浏览器页面即可使用新功能
2. 旧的笔记不受影响，正常显示
3. 新笔记可以选择性添加图片

### 对于开发者

1. 阅读 [`BACKEND_UPDATE_GUIDE.md`](./BACKEND_UPDATE_GUIDE.md)
2. 更新数据库表结构
3. 修改后端 API 代码
4. 测试所有功能
5. 部署新版本

---

## 🐛 已知问题

- 目前导出功能不包含图片，需要手动保存
- 移动端大文件上传可能较慢
- Safari 浏览器可能需要用户授权剪贴板访问

---

## 📅 版本历史

### v2.0 (2025-12-23)
- ✅ 新增图片加密上传功能
- ✅ 新增分享链接复制按钮
- ✅ 优化阅后即焚支持图片
- ✅ 改进 UI/UX 体验
- ✅ 新增 Toast 通知系统

### v1.0 (之前)
- 基础的文本加密笔记功能
- 阅后即焚分享功能
- AI 智能总结功能
- PWA 离线支持

---

## 📞 反馈与支持

如有问题或建议，请联系:
- 官网: [www.zzzmxxkj.com](https://www.zzzmxxkj.com)
- 项目仓库: [提交 Issue]

---

**享受更安全、更便捷的加密笔记体验！** 🎉